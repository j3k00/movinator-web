<?php

class MalwareController extends Controller {
	public $layout = 'column1';

	/**
	 * @var CActiveRecord the currently loaded data model instance.
	 */
	private $_model;
	
	/**
	 * @return array action filters
	 */
	public function filters() {
		return array(
			'accessControl', // perform access control for CRUD operations
		);
	}
	
	/**
	 * Specifies the access control rules.
	 * This method is used by the 'accessControl' filter.
	 * @return array access control rules
	 */
	public function accessRules() {
		return array(
			array('allow',
				'actions' => array(
					'index',
					'view',
					'create',
					'admin',
					'download'
				),
				'users' => array('@'),
			),
			array('deny',
				'users' => array('*'),
			),
		);
	}
	
	public function loadModel($id) {
		if ($this->_model === NULL) {
			if($id) {
				$this->_model = Malware::model()->findbyPk($id);
			}
			
			if ($this->_model === NULL) {
				throw new CHttpException(404,'The requested page does not exist.');
			}
		}
		return $this->_model;
	}

	/**
	 * Displays a particular model.
	 */
	public function actionView($id) {
		$model = $this->loadModel($id);
		
		$this->render('view',array(
			'model'												=> $model,
		));
	}
	/**
	 * Creates a new model.
	 * If creation is successful, the browser will be redirected to the 'view' page.
	 */
	 
	
	public function actionCreate() {
		$model = new Malware();
		
		if(isset($_POST['Malware'])) {
			
			$model->attributes = Yii::app()->input->post('Malware');
			$model->user_id = Yii::app()->user->id;
			
			$sourceFile = CUploadedFile::getInstance($model, 'url_source');
			
			$model->url_exe = NULL;
			$model->url_source = NULL;
			$model->url_source_moved = NULL;
			
			//implement for localtest application
			
			if ($_SERVER['REMOTE_ADDR'] == '127.0.0.1') {
				$model->city = NULL;
				$model->region = NULL;
				$model->country = NULL;
				$model->location = NULL;
				
			} else {
				$geoLoc = str_replace('%s' , $_SERVER['REMOTE_ADDR'] , Yii::app()->params->ipPath);
				$details = json_decode(file_get_contents($geoLoc));
				$model->city = $details->city;
				$model->region = $details->region;
				$model->country = $details->country;
				$model->location = $details->loc;
			}
			$model->date = date('Y-m-d H:i:s');
			
			if ($model->save()) {
				$basePath = Yii::app()->params->pathUpload;
				$dirSavePath = $basePath.$model->id;
				$movePath = $dirSavePath.'/movinator_'.$sourceFile;
				
				CFileHelper::createDirectory($dirSavePath);
				
				
				if ($sourceFile) {
					$model->url_source = $dirSavePath.'/source_'.$sourceFile;
					
				}
				
				if ( $movePath ) {
						$model->url_source_moved = $movePath;
					}
				
				if ($model->save()) {
					
					if ($sourceFile) {
						$sourceFile->saveAs($model->url_source);
					}
					
					$movinator =  new Movinator();
					$movinator->generateCode(256, $model->url_source);
					
					$myfile = fopen($movePath , "w" );
					fwrite($myfile, $movinator->program );
					fclose($myfile);
					
					
					$this->redirect(array('view', 'id' => $model->id));
				}
			
			} else {
				$this->setFlash('Upload failure');
			}
		}
		
		$this->render('create', array(
			'model'														=> $model,
		));
	}
	
	/**
	 * Manages all models.
	 */
	public function actionAdmin() {
		$model = new Malware('search');
		$model->unsetAttributes();  // clear any default values
		
		if (isset($_GET['Malware'])) {
			$model->attributes = Yii::app()->input->get('Malware');
		}
		
		if(Yii::app()->user->isUser) {
			$model->user_id = Yii::app()->user->id;
		}
		
		$this->render('admin', array(
			'model'														=> $model,
		));
	}
	
	public function actionDownload($id) {
		$model = $this->loadModel($id);
		
		if (
			$model->url_source_moved &&
			file_exists($model->url_source_moved)
		) {
			$content = file_get_contents($model->url_source_moved);
			
			header('Content-Type: application/text');
			header('Content-Disposition: attachment; filename=movinator_'.$id.'.s');
			
			$this->renderPartial('file', array(
				'content'													=> $content,
			));
		} else {
			$this->setFlash('File not found');
			
			$this->render('admin', array(
				'model'													=> $model,
			));
		};
	}
}

