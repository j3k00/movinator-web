<?php

class MalwareController extends Controller {
	public $layout = 'column1';

	/**
	 * @var CActiveRecord the currently loaded data model instance.
	 */
	private $_model;
	
	/**
	 * @return array action filters
	 */
	public function filters() {
		return array(
			'accessControl', // perform access control for CRUD operations
		);
	}
	
	/**
	 * Specifies the access control rules.
	 * This method is used by the 'accessControl' filter.
	 * @return array access control rules
	 */
	public function accessRules() {
		return array(
			array('allow',  // allow all users to access 'index' and 'view' actions.
				'actions'=>array('index','view'),
				'users'=>array('*'),
			),
			array('allow', // allow authenticated users to access all actions
				'users'=>array('@'),
			),
			array('deny',  // deny all users
				'users'=>array('*'),
			),
		);
	}
	
	public function loadModel($id) {
		if ($this->_model === NULL) {
			if($id) {
				$this->_model = Malware::model()->findbyPk($id);
			}
			
			if ($this->_model === NULL) {
				throw new CHttpException(404,'The requested page does not exist.');
			}
		}
		return $this->_model;
	}

	/**
	 * Displays a particular model.
	 */
	public function actionView($id) {
		$model = $this->loadModel($id);
		
		$this->render('view',array(
			'model'												=> $model,
		));
	}
	/**
	 * Creates a new model.
	 * If creation is successful, the browser will be redirected to the 'view' page.
	 */
	 
	
	public function actionCreate() {
		$model = new Malware();
		
		if(isset($_POST['Malware'])) {
			
			$model->attributes = $_POST['Malware'];
			$model->user_id = Yii::app()->user->id;
			
			$exeFile = CUploadedFile::getInstance($model, 'url_exe');
			$sourceFile = CUploadedFile::getInstance($model, 'url_source');
			
			$model->url_exe = NULL;
			$model->url_source = NULL;
			$model->url_source_moved = NULL;
			
			//$_SERVER['REMOTE_ADDR']
			
			$geoLoc = str_replace('%s' , '157.27.136.246', Yii::app()->params->ipPath);
			
			$details = json_decode(file_get_contents($geoLoc));
			
			$model->city = $details->city;
			$model->region = $details->region;
			$model->country = $details->country;
			$model->location = $details->loc;
			$model->date = date('Y-m-d H:i:s');
			
			if ($model->save()) {
				$basePath = Yii::app()->params->pathUpload;
				$dirSavePath = $basePath.$model->id;
				$movePath = $dirSavePath.'/movinator_'.$sourceFile;
				
				CFileHelper::createDirectory($dirSavePath);
				
				
				if ($exeFile) {
					$model->url_exe = $dirSavePath.'/exe_'.$exeFile;
				}
				
				if ($sourceFile) {
					$model->url_source = $dirSavePath.'/source_'.$sourceFile;
					
				}
				
				if ( $movePath ) {
						$model->url_source_moved = $movePath;
					}
				
				if ($model->save()) {
					if ($exeFile) {
						$exeFile->saveAs($model->url_exe);
					}
					
					if ($sourceFile) {
						$sourceFile->saveAs($model->url_source);
					}
					
					$movinator =  new Movinator();
					$movinator->generateCode(256, $model->url_source);
					print_r($movePath);
					$myfile = fopen($movePath , "w" );
					fwrite($myfile, $movinator->program );
					fclose($myfile);
					
					
					$this->redirect(array('view', 'id' => $model->id));
				}
			
			}
		}
		
		$this->render('create', array(
			'model'														=> $model,
		));
	}
	
	/**
	 * Manages all models.
	 */
	public function actionAdmin() {
		$model = new Malware('search');
		$model->unsetAttributes();  // clear any default values
		
		if(Yii::app()->user->isUser) {
			$model->user_id = Yii::app()->user->id;
		}
		
		if (isset($_GET['Malware'])) {
			$model->attributes = $_GET['Malware'];
		}
		
		$this->render('admin', array(
			'model'														=> $model,
		));
	}
	
	public function actionDownload($id) {
		$model = $this->loadModel($id);
		
		$content = file_get_contents($model->url_source_moved);
		
		$this->renderPartial('file', array(
			'content'													=> $content,
		));
		
		header('Content-Type: application/text');
		header('Content-Disposition: attachment; filename=movinator_'.$id.'.s');
	}
}

